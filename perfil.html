<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - Eri Mich&lt;3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="inicio.html">Eri Mich&lt;3</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="inicio.html"><i class="bi bi-house-door-fill me-1"></i> Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="perfil.html"><i class="bi bi-person me-1"></i> Perfil</a>
                    </li>
                    <li class="nav-item"> <!-- Añado el elemento perdido y el ID -->
                        <a class="nav-link" href="amigos.html" id="navAmigos"><i class="bi bi-people me-1"></i>
                            Amigos</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <a href="editar-perfil.html" class="btn btn-outline-light me-2">
                        <i class="bi bi-pencil-square me-1"></i> Editar perfil
                    </a>
                    <button class="btn btn-outline-light" onclick="cerrarSesion()">
                        <i class="bi bi-box-arrow-right me-1"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5 pt-4 mb-5">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card text-center">
                    <div class="card-body">
                        <img id="perfilFoto" src="assets/blanco y negro.webp" class="rounded-circle mb-3"
                            alt="Foto de perfil" width="120" height="120">
                        <h5 class="card-title mb-0" id="perfilNombre">Nombre Usuario</h5>
                        <p class="text-muted" id="perfilUsuario">@usuario</p>
                        <p class="small" id="perfilBiografia">Breve biografía del usuario. Aquí puedes escribir algo
                            sobre ti.</p>
                        <div class="d-grid gap-2">
                            <a href="editar-perfil.html" class="btn btn-primary btn-sm"><i
                                    class="bi bi-pencil-square me-1"></i> Editar perfil</a>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between small">
                            <div class="text-center">
                                <div class="fw-bold" id="perfilAmigos">0</div>
                                <div class="text-muted">Amigos</div>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold" id="perfilPublicaciones">0</div>
                                <div class="text-muted">Publicaciones</div>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold" id="perfilSeguidores">0</div>
                                <div class="text-muted">Seguidores</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Información de contacto</h6>
                    </div>
                    <div class="card-body small">
                        <p class="mb-1"><i class="bi bi-envelope me-2"></i><span
                                id="perfilEmail">correo@ejemplo.com</span></p>
                        <p class="mb-1"><i class="bi bi-geo-alt me-2"></i><span id="perfilCiudad">Ciudad, País</span>
                        </p>
                        <p class="mb-1"><i class="bi bi-telephone me-2"></i><span id="perfilTelefono">Teléfono</span>
                        </p>
                    </div>
                </div>

                <!-- Redes sociales -->
                <div class="card mt-4">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Redes sociales</h6>
                    </div>
                    <div class="card-body small">
                        <div class="d-flex flex-column gap-2">
                            <a href="#" id="perfilFacebook" class="text-decoration-none d-flex align-items-center gap-2"
                                style="display: none;">
                                <i class="bi bi-facebook text-primary fs-5"></i>
                                <span>@<span class="facebook-username">usuario</span></span>
                            </a>
                            <a href="#" id="perfilInstagram"
                                class="text-decoration-none d-flex align-items-center gap-2" style="display: none;">
                                <i class="bi bi-instagram text-danger fs-5"></i>
                                <span>@<span class="instagram-username">usuario</span></span>
                            </a>
                            <a href="#" id="perfilTwitter" class="text-decoration-none d-flex align-items-center gap-2"
                                style="display: none;">
                                <i class="bi bi-twitter-x fs-5"></i>
                                <span>@<span class="twitter-username">usuario</span></span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-white">
                        <h6 class="mb-0">Publicaciones</h6>
                    </div>
                    <div class="card-body" id="listaPublicaciones">
                        <p class="text-muted mb-0">Aquí se mostrarán las publicaciones del usuario.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cerrar sesión -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title" id="logoutModalLabel">
                        <i class="bi bi-box-arrow-right text-danger me-2"></i>
                        Cerrar Sesión
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-question-circle text-primary" style="font-size: 3rem;"></i>
                    <p class="mt-3 mb-0">¿Estás seguro que deseas cerrar sesión?</p>
                    <small class="text-muted">Tendrás que iniciar sesión nuevamente para acceder a tu cuenta</small>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                    <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger px-4" onclick="confirmarLogout()">
                        <i class="bi bi-box-arrow-right me-1"></i> Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Función para cerrar sesión
        function cerrarSesion() {
            const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
            modal.show();
        }

        // Función para confirmar el logout
        function confirmarLogout() {
            window.location.href = 'redsocial_logout.php';
        }

        // Cargar datos del usuario autenticado o solicitado
        document.addEventListener("DOMContentLoaded", function () {
            // Obtener ID de la URL si existe
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('id');
            const apiEndpoint = userId ? `api_perfil_completo.php?id=${userId}` : "api_perfil_completo.php";

            fetch(apiEndpoint)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success" && data.user) {
                        // Actualizar nombre de usuario
                        const nombreEl = document.getElementById("perfilNombre");
                        if (nombreEl) {
                            nombreEl.textContent = data.user.username || "Usuario";
                        }

                        // Actualizar email/username
                        const usuarioEl = document.getElementById("perfilUsuario");
                        if (usuarioEl) {
                            const username = data.user.username || "usuario";
                            usuarioEl.textContent = "@" + username;
                        }

                        // Actualizar foto de perfil
                        const fotoEl = document.getElementById("perfilFoto");
                        if (fotoEl && data.user.foto_perfil) {
                            fotoEl.src = data.user.foto_perfil;
                        }

                        // Actualizar estadísticas
                        if (data.user.stats) {
                            const amigosEl = document.getElementById("perfilAmigos");
                            if (amigosEl) amigosEl.textContent = data.user.stats.amigos;

                            const postsEl = document.getElementById("perfilPublicaciones");
                            if (postsEl) postsEl.textContent = data.user.stats.publicaciones;
                        }

                        // Ocultar botones de edición si no es el perfil propio
                        if (!data.user.is_own_profile) {
                            const editBtns = document.querySelectorAll('a[href="editar-perfil.html"]');
                            editBtns.forEach(btn => btn.style.display = 'none');

                            // Mostrar botones de acción (Añadir/Eliminar) si fuera necesario en el futuro
                            // Por ahora, solo es visualización
                        }

                        // Actualizar biografía
                        const biografiaEl = document.getElementById("perfilBiografia");
                        if (biografiaEl) {
                            biografiaEl.textContent = data.user.biografia || "Este usuario no ha agregado una biografía.";
                        }

                        // Actualizar email
                        const emailEl = document.getElementById("perfilEmail");
                        if (emailEl && data.user.email) {
                            emailEl.textContent = data.user.email;
                        }

                        // Actualizar ciudad
                        const ciudadEl = document.getElementById("perfilCiudad");
                        if (ciudadEl) {
                            ciudadEl.textContent = data.user.ciudad || "No especificada";
                        }

                        // Actualizar teléfono
                        const telefonoEl = document.getElementById("perfilTelefono");
                        if (telefonoEl) {
                            telefonoEl.textContent = data.user.telefono || "No especificado";
                        }

                        // Actualizar redes sociales
                        console.log('Redes sociales recibidas:', {
                            facebook: data.user.facebook,
                            instagram: data.user.instagram,
                            twitter: data.user.twitter
                        }); // Depuración

                        const facebookEl = document.getElementById("perfilFacebook");
                        if (facebookEl && data.user.facebook) {
                            facebookEl.href = "https://facebook.com/" + data.user.facebook;
                            facebookEl.style.display = "flex";
                            document.querySelector('.facebook-username').textContent = data.user.facebook;
                            console.log('Mostrando Facebook:', data.user.facebook);
                        } else {
                            facebookEl.style.display = "none";
                            console.log('Ocultando Facebook');
                        }

                        const instagramEl = document.getElementById("perfilInstagram");
                        if (instagramEl && data.user.instagram) {
                            instagramEl.href = "https://instagram.com/" + data.user.instagram;
                            instagramEl.style.display = "flex";
                            document.querySelector('.instagram-username').textContent = data.user.instagram;
                            console.log('Mostrando Instagram:', data.user.instagram);
                        } else {
                            instagramEl.style.display = "none";
                            console.log('Ocultando Instagram');
                        }

                        const twitterEl = document.getElementById("perfilTwitter");
                        if (twitterEl && data.user.twitter) {
                            twitterEl.href = "https://x.com/" + data.user.twitter;
                            twitterEl.style.display = "flex";
                            document.querySelector('.twitter-username').textContent = data.user.twitter;
                            console.log('Mostrando Twitter/X:', data.user.twitter);
                        } else {
                            twitterEl.style.display = "none";
                            console.log('Ocultando Twitter/X');
                        }
                        if (data.warning) {
                            console.warn('Advertencia:', data.warning);
                        }

                        // Una vez que tenemos los datos del usuario, cargamos sus publicaciones
                        // data.user.id debería venir del backend si es el perfil propio o ajeno
                        // Si api_perfil_completo no devuelve ID, usaremos el userId de URL o fallaremos elegantemente
                        const idParaPublicaciones = userId || (data.user.id || null);
                        if (idParaPublicaciones) {
                            fetch(`api_publicaciones.php?usuario_id=${idParaPublicaciones}`)
                                .then(res => res.json())
                                .then(pubData => {
                                    if (pubData.status === 'success') {
                                        renderizarPublicaciones(pubData.publicaciones);
                                    } else {
                                        document.getElementById('listaPublicaciones').innerHTML = '<p class="text-danger">Error cargando publicaciones.</p>';
                                    }
                                })
                                .catch(err => console.error('Error pubs:', err));
                        } else {
                            // Fallback: tratar de cargar publicaciones del usuario actual si no hay ID
                            // (Aunque api_publicaciones sin params carga el feed, no el perfil. Mejor no cargar nada si hay duda)
                        }
                    }
                })
                .catch((error) => {
                    console.error('Error al cargar datos del perfil:', error);
                });

            // Cargar notificaciones del usuario actual para la navbar
            fetch('api_usuario_actual.php')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.user.stats && data.user.stats.solicitudes > 0) {
                        const navAmigos = document.getElementById('navAmigos');
                        if (navAmigos) {
                            navAmigos.innerHTML += ` <span class="badge bg-danger rounded-pill ms-1">${data.user.stats.solicitudes}</span>`;
                        }
                    }
                })
                .catch(err => console.error('Error loading user stats:', err));

            // ------------- CARGAR PUBLICACIONES DEL PERFIL -------------
            cargarPublicacionesPerfil(userId);
        });

        // Función para cargar publicaciones del usuario del perfil
        function cargarPublicacionesPerfil(profileId) {
            const container = document.getElementById('listaPublicaciones');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';

            // Si no hay ID en la URL, se asume que es el perfil propio (necesitamos saber el ID propio o dejar que la API lo infiera si usáramos lógica de "mi perfil", pero la API requiere ID explícito o usa el feed. 
            // Para el perfil propio sin ID en URL, necesitamos primero saber quién es el usuario actual.
            // O mejor aún, api_perfil_completo devuelve el user ID del perfil que estamos viendo.

            // Vamos a encadenar esto después de obtener los datos del perfil si no tenemos ID, 
            // o haremos una llamada extra segura.

            // Estrategia: Si tenemos userId de URL, lo usamos. Si no, esperamos a que api_perfil_completo nos de el ID.
            // Arriba ya llamamos a api_perfil_completo. Vamos a mover esta llamada ADENTRO del then de api_perfil_completo para asegurar que tenemos el ID.
        }

        function renderizarPublicaciones(publicaciones) {
            const container = document.getElementById('listaPublicaciones');
            if (publicaciones.length === 0) {
                container.innerHTML = '<div class="alert alert-light text-center">Este usuario aún no ha publicado nada.</div>';
                return;
            }

            let html = '';
            publicaciones.forEach(pub => {
                const likeClass = pub.liked_by_user ? 'text-danger' : 'text-muted';
                const likeIcon = pub.liked_by_user ? 'bi-heart-fill' : 'bi-heart';

                // Procesar imagen si existe
                let imagenHtml = '';
                if (pub.imagen && pub.imagen !== 'null' && pub.imagen !== '') {
                    imagenHtml = `<img src="${pub.imagen}" class="img-fluid rounded mb-3 w-100" alt="Imagen de la publicación" onerror="this.style.display='none'">`;
                }

                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <img src="${pub.foto_usuario || 'assets/blanco y negro.webp'}" class="rounded-circle me-2" alt="Foto" width="40" height="40">
                                <div>
                                    <h6 class="mb-0 fw-bold">${pub.nombre}</h6>
                                    <small class="text-muted">${pub.fecha}</small>
                                </div>
                            </div>
                            <p class="card-text">${pub.contenido}</p>
                            ${imagenHtml}
                            <div class="d-flex align-items-center">
                                <button class="btn btn-link text-decoration-none p-0 me-3 ${likeClass}" onclick="toggleLike(${pub.id}, this)">
                                    <i class="bi ${likeIcon} me-1"></i> <span class="likes-count">${pub.likes_count}</span>
                                </button>
                                <button class="btn btn-link text-decoration-none p-0 text-muted">
                                    <i class="bi bi-chat me-1"></i> Comentar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Función para dar like (copiada de inicio.html para funcionalidad completa)
        function toggleLike(publicacionId, btn) {
            const icon = btn.querySelector('i');
            const counter = btn.querySelector('.likes-count');

            fetch('acciones/toggle_like.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `publicacion_id=${publicacionId}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.liked) {
                            btn.classList.remove('text-muted');
                            btn.classList.add('text-danger');
                            icon.classList.remove('bi-heart');
                            icon.classList.add('bi-heart-fill');
                        } else {
                            btn.classList.remove('text-danger');
                            btn.classList.add('text-muted');
                            icon.classList.remove('bi-heart-fill');
                            icon.classList.add('bi-heart');
                        }
                        counter.textContent = data.likes_count;
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>

</html>